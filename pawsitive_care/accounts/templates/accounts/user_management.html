{% extends 'accounts/base.html' %}

{% block title %}User Management - Pawsitive Care{% endblock %}

{% block content %}
<style>
  /* Prevent modal backdrop from appearing */
  .modal-backdrop,
  .modal-backdrop.fade,
  .modal-backdrop.show,
  .modal-backdrop.fade.show {
    display: none !important;
    opacity: 0 !important;
    visibility: hidden !important;
  }

  /* Ensure body doesn't get modal-open class effects */
  body.modal-open {
    overflow: auto !important;
    padding-right: 0 !important;
  }
</style>

<div class="app-shell" id="appShell">
  <!-- ========= SIDEBAR ========= -->
  <aside class="app-sidebar glass" aria-label="Primary">
    <div class="sidebar-header">
      <button class="sidebar-toggle" type="button" aria-label="Collapse sidebar">
        <i class="fas fa-bars"></i>
      </button>
      <span class="sidebar-title">Admin</span>
    </div>

    <!-- Sections -->
    <nav class="sidebar-nav">
      <div class="sidebar-section">
        <div class="sidebar-section-label">Users</div>
        <a href="{% url 'accounts:user_management' %}" class="sidebar-link {% if request.resolver_match.url_name == 'user_management' %}active{% endif %}">
          <i class="fas fa-users"></i><span>Manage Users</span>
        </a>
        <a href="{% url 'accounts:promote_clients' %}" class="sidebar-link {% if request.resolver_match.url_name == 'promote_clients' %}active{% endif %}">
          <i class="fas fa-user-plus"></i><span>Promote Clients</span>
        </a>
        <a href="#" class="sidebar-link">
          <i class="fas fa-user-tie"></i><span>Add Staff</span>
        </a>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-section-label">Inventory</div>
        <a href="{% url 'inventory:item_list' %}" class="sidebar-link">
          <i class="fas fa-boxes"></i><span>All Items</span>
        </a>
        <a href="{% url 'inventory:item_list' %}?low_stock=1" class="sidebar-link">
          <i class="fas fa-triangle-exclamation"></i><span>Low Stock</span>
        </a>
        <a href="{% url 'inventory:item_create' %}" class="sidebar-link">
          <i class="fas fa-plus"></i><span>Add Item</span>
        </a>
        <a href="{% url 'inventory:reports' %}" class="sidebar-link">
          <i class="fas fa-chart-line"></i><span>Reports</span>
        </a>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-section-label">Blog</div>
        <a href="{% url 'petmedia:blog_list' %}" class="sidebar-link">
          <i class="fas fa-edit"></i><span>All Posts</span>
        </a>
        <a href="{% url 'petmedia:create_post' %}" class="sidebar-link">
          <i class="fas fa-plus"></i><span>Create Post</span>
        </a>
        <a href="{% url 'petmedia:create_professional_post' %}" class="sidebar-link">
          <i class="fas fa-user-md"></i><span>Professional Post</span>
        </a>
        <a href="{% url 'petmedia:user_posts' %}" class="sidebar-link">
          <i class="fas fa-star"></i><span>My Posts</span>
        </a>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-section-label">System</div>
        <a href="{% url 'appointments:staff_calendar' %}" class="sidebar-link">
          <i class="fas fa-calendar"></i><span>Appointments</span>
        </a>
        <a href="{% url 'billing:view_bills' %}" class="sidebar-link">
          <i class="fas fa-receipt"></i><span>Billing</span>
        </a>
        <a href="{% url 'pets:pet_list' %}" class="sidebar-link">
          <i class="fas fa-paw"></i><span>Pets</span>
        </a>
        <a href="{% url 'communication:communication_list' %}" class="sidebar-link">
          <i class="fas fa-comments"></i><span>Communications</span>
        </a>
        <a href="#" class="sidebar-link">
          <i class="fas fa-chart-bar"></i><span>Reports</span>
        </a>
        <a href="#" class="sidebar-link">
          <i class="fas fa-gear"></i><span>Settings</span>
        </a>
      </div>
    </nav>
  </aside>

  <!-- ========== MAIN CONTENT ========== -->
  <main class="app-main">
    {% csrf_token %}
    <div class="row">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h2 class="m-0"><i class="fas fa-users me-2"></i> User Management</h2>
            <p class="text-muted mb-0">Manage all system users and their roles</p>
          </div>
          <div class="btn-group" role="group" aria-label="User actions">
            <a href="{% url 'accounts:register' %}" class="btn btn-accent">
              <i class="fas fa-user-plus me-1"></i> Add New User
            </a>
            <a href="{% url 'accounts:promote_clients' %}" class="btn btn-ghost">
              <i class="fas fa-arrow-up me-1"></i> Promote Staff
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- User Statistics -->
    <div class="row g-3 mb-4">
      <div class="col-12">
        <div class="card glass card-indigo h-100">
          <div class="card-body text-center">
            <h3 class="solid-accent-text mb-1">
              {{ stats.total_users }}
            </h3>
            <small class="text-muted"><i class="fas fa-users me-1"></i>Total Users</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Role Statistics -->
    <div class="row g-3 mb-4">
      <div class="col-6 col-lg-3">
        <div class="card glass card-rose h-100">
          <div class="card-body text-center">
            <h3 class="solid-accent-text mb-1">
              {{ stats.admin_count }}
            </h3>
            <small class="text-muted"><i class="fas fa-user-shield me-1"></i>Administrators</small>
          </div>
        </div>
      </div>
      <div class="col-6 col-lg-3">
        <div class="card glass card-success h-100">
          <div class="card-body text-center">
            <h3 class="solid-accent-text mb-1">
              {{ stats.vet_count }}
            </h3>
            <small class="text-muted"><i class="fas fa-user-md me-1"></i>Veterinarians</small>
          </div>
        </div>
      </div>
      <div class="col-6 col-lg-3">
        <div class="card glass card-amber h-100">
          <div class="card-body text-center">
            <h3 class="solid-accent-text mb-1">
              {{ stats.staff_count }}
            </h3>
            <small class="text-muted"><i class="fas fa-user-tie me-1"></i>Staff Members</small>
          </div>
        </div>
      </div>
      <div class="col-6 col-lg-3">
        <div class="card glass card-teal h-100">
          <div class="card-body text-center">
            <h3 class="solid-accent-text mb-1">
              {{ stats.client_count }}
            </h3>
            <small class="text-muted"><i class="fas fa-user me-1"></i>Clients</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Users Table (Modern) -->
    <div class="card glass table-card">
      <div class="card-header soft-accent-bg">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
          <div class="d-flex align-items-center gap-2">
            <h5 class="m-0"><i class="fas fa-list me-2"></i> All Users</h5>
          </div>

          <div class="d-flex flex-wrap align-items-center gap-2">
            <!-- Search -->
            <div class="input-group input-group-sm table-toolbar-search">
              <span class="input-group-text bg-transparent border-0 ps-0">
                <i class="fas fa-search"></i>
              </span>
              <input type="text" class="form-control" placeholder="Search usersâ€¦" id="userSearch" aria-label="Search users">
            </div>

            <!-- Role Filter -->
            <select id="roleFilter" class="form-select form-select-sm">
              <option value="">Role: All</option>
              <option value="Admin">Admin</option>
              <option value="Veterinarian">Veterinarian</option>
              <option value="Staff">Staff</option>
              <option value="Client">Client</option>
            </select>

            <!-- Status Filter -->
            <select id="statusFilter" class="form-select form-select-sm">
              <option value="">Status: All</option>
              <option value="Active">Active</option>
              <option value="Inactive">Inactive</option>
            </select>

            <!-- Density -->
            <button class="btn btn-ghost btn-sm" id="densityToggle" type="button" aria-pressed="false" title="Toggle density">
              <i class="fas fa-compress-arrows-alt me-1"></i> Compact
            </button>
          </div>
        </div>
      </div>

      <div class="table-wrap table-responsive">
        <table class="table table-modern align-middle mb-0" id="usersTable">
          <thead>
            <tr>
              <th style="width:42px;">
                <input class="form-check-input" type="checkbox" id="selectAll">
              </th>

              <th data-sortkey="user">
                User <i class="fas fa-sort sort-indicator"></i>
              </th>

              <th data-sortkey="email">
                Email <i class="fas fa-sort sort-indicator"></i>
              </th>

              <th data-sortkey="phone">
                Phone <i class="fas fa-sort sort-indicator"></i>
              </th>

              <th data-sortkey="role">
                Role <i class="fas fa-sort sort-indicator"></i>
              </th>

              <th data-sortkey="status">
                Status <i class="fas fa-sort sort-indicator"></i>
              </th>

              <th data-sortkey="joined" style="min-width: 120px;">
                Joined <i class="fas fa-sort sort-indicator"></i>
              </th>

              <th class="text-end" style="width:120px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
            <tr data-role="{% if user.is_admin %}Admin{% elif user.is_vet %}Veterinarian{% elif user.is_staff_member %}Staff{% else %}Client{% endif %}" data-status="{% if user.is_active %}Active{% else %}Inactive{% endif %}" data-joined="{{ user.date_joined|date:'U' }}">
              <td>
                <input class="form-check-input row-check" type="checkbox">
              </td>

              <!-- User + avatar/handle -->
              <td data-value="{{ user.get_full_name|default:user.username }}">
                <div class="user-cell d-flex align-items-center gap-2">
                  <img class="avatar-sm rounded-circle" src="https://api.dicebear.com/7.x/identicon/svg?seed={{ user.username }}" alt="{{ user.username }} avatar" width="32" height="32" />
                  <div class="user-meta">
                    <div class="user-name fw-semibold">
                      {{ user.get_full_name|default:user.username }}
                    </div>
                    {% if not user.get_full_name %}
                    <div class="user-handle text-muted small">@
                      {{ user.username }}
                    </div>
                    {% endif %}
                  </div>
                </div>
              </td>

              <!-- Email -->
              <td data-value="{{ user.email|default:'' }}">
                {% if user.email %}
                <a href="mailto:{{ user.email }}" class="text-decoration-none">
                  {{ user.email }}</a>
                {% else %}
                <span class="text-muted">Not provided</span>
                {% endif %}
              </td>

              <!-- Phone -->
              <td data-value="{{ user.phone|default:'' }}">
                {% if user.phone %}
                <a href="tel:{{ user.phone }}" class="text-decoration-none">
                  {{ user.phone }}</a>
                {% else %}
                <span class="text-muted">Not provided</span>
                {% endif %}
              </td>

              <!-- Role chip -->
              <td data-value="{% if user.is_admin %}Admin{% elif user.is_vet %}Veterinarian{% elif user.is_staff_member %}Staff{% else %}Client{% endif %}">
                {% if user.is_admin %}
                <span class="chip chip-admin"><i class="fas fa-user-shield me-1"></i> Admin</span>
                {% elif user.is_vet %}
                <span class="chip chip-vet"><i class="fas fa-user-md me-1"></i> Veterinarian</span>
                {% elif user.is_staff_member %}
                <span class="chip chip-staff"><i class="fas fa-user-tie me-1"></i> Staff</span>
                {% else %}
                <span class="chip chip-client"><i class="fas fa-user me-1"></i> Client</span>
                {% endif %}
              </td>

              <!-- Status pill -->
              <td data-value="{% if user.is_active %}Active{% else %}Inactive{% endif %}">
                {% if user.is_active %}
                <span class="status-pill status-active"><span class="dot"></span> Active</span>
                {% else %}
                <span class="status-pill status-inactive"><span class="dot"></span> Inactive</span>
                {% endif %}
              </td>

              <!-- Joined (sortable by timestamp) -->
              <td data-value="{{ user.date_joined|date:'U' }}">
                <small>
                  {{ user.date_joined|date:'M d, Y' }}</small>
              </td>

              <!-- Actions -->
              <td class="text-end">
                <div class="btn-group btn-group-sm" role="group" aria-label="Row actions">
                  <a href="{% url 'accounts:user_detail' user.id %}" class="btn btn-ghost" title="View"><i class="fas fa-eye"></i></a>
                  <a href="{% url 'accounts:user_edit' user.id %}" class="btn btn-accent" title="Edit"><i class="fas fa-edit"></i></a>
                  {% if user != request.user %}
                  <button type="button" class="btn btn-ghost delete-user-btn" data-bs-toggle="modal" data-bs-target="#deleteUserModal" data-user-id="{{ user.id }}" data-user-name="{{ user.get_full_name|default:user.username }}" title="Delete">
                    <i class="fas fa-trash"></i>
                  </button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% empty %}
            <tr class="table-empty">
              <td colspan="8" class="text-center py-4">
                <i class="fas fa-users fa-2x text-muted mb-2 d-block"></i>
                <p class="text-muted mb-0">No users found.</p>
              </td>
            </tr>
            {% endfor %}
          </tbody>


        </table>
      </div>
    </div>



    <!-- Role Legend -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="card glass card-teal">
          <div class="card-header soft-accent-bg">
            <h6 class="m-0"><i class="fas fa-info-circle me-2"></i> Role Permissions</h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-3">
                <h6><span class="badge badge-solid" style="background:#ef4444;color:#fff;">Admin</span></h6>
                <ul class="small mb-0">
                  <li>Full system access</li>
                  <li>User management</li>
                  <li>System configuration</li>
                </ul>
              </div>
              <div class="col-md-3">
                <h6><span class="badge badge-solid" style="background:#22c55e;color:#fff;">Veterinarian</span></h6>
                <ul class="small mb-0">
                  <li>Patient management</li>
                  <li>Medical records</li>
                  <li>Prescriptions</li>
                </ul>
              </div>
              <div class="col-md-3">
                <h6><span class="badge badge-solid" style="background:#f59e0b;color:#fff;">Staff</span></h6>
                <ul class="small mb-0">
                  <li>Appointment scheduling</li>
                  <li>Client management</li>
                  <li>Basic reception</li>
                </ul>
              </div>
              <div class="col-md-3">
                <h6><span class="badge badge-solid" style="background:#06b6d4;color:#fff;">Client</span></h6>
                <ul class="small mb-0">
                  <li>Book appointments</li>
                  <li>View pet records</li>
                  <li>Manage profile</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Delete User Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteUserModalLabel">Delete User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete user <strong id="deleteUserName"></strong>?</p>
        <p class="text-muted">This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete User</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Clean up any existing modal backdrop on page load
    const existingBackdrop = document.querySelector('.modal-backdrop');
    if (existingBackdrop) {
      existingBackdrop.remove();
    }
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    document.body.style.paddingRight = '';

    const deleteModalElement = document.getElementById('deleteUserModal');
    const deleteUserName = document.getElementById('deleteUserName');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    let userIdToDelete = null;

    console.log('Delete modal script loaded');

    // Listen for modal show event
    deleteModalElement.addEventListener('show.bs.modal', function(event) {
      console.log('Modal show event triggered');
      // Button that triggered the modal
      const button = event.relatedTarget;
      userIdToDelete = button.getAttribute('data-user-id');
      const userName = button.getAttribute('data-user-name');

      console.log('User ID to delete:', userIdToDelete, 'User name:', userName);

      // Update modal content
      deleteUserName.textContent = userName;
    });

    // Handle confirm delete
    confirmDeleteBtn.addEventListener('click', function() {
      console.log('Confirm delete clicked for user ID:', userIdToDelete);
      if (userIdToDelete) {
        // Immediately remove all backdrops and modal-related classes
        const removeAllBackdrops = () => {
          const backdrops = document.querySelectorAll('.modal-backdrop');
          backdrops.forEach(backdrop => backdrop.remove());
          document.body.classList.remove('modal-open');
          document.body.style.overflow = '';
          document.body.style.paddingRight = '';
        };

        // Remove immediately
        removeAllBackdrops();

        // Hide the modal instance
        const modal = bootstrap.Modal.getInstance(deleteModalElement);
        if (modal) {
          modal.dispose(); // Completely dispose of the modal
        }

        // Force hide the modal element
        deleteModalElement.style.display = 'none';
        deleteModalElement.classList.remove('show');

        // Create and submit form immediately
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/accounts/users/${userIdToDelete}/delete/`;

        // Add CSRF token
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
        form.appendChild(csrfInput);

        document.body.appendChild(form);

        // Final cleanup before submit
        setTimeout(() => {
          removeAllBackdrops();
          form.submit();
        }, 50);
      }
    }); // Also add direct click event for debugging
    const deleteButtons = document.querySelectorAll('.delete-user-btn');
    deleteButtons.forEach(button => {
      button.addEventListener('click', function() {
        console.log('Delete button clicked directly');
      });
    });
  });
</script>

<!-- Remove modal backdrop -->
<script>
  // Aggressively prevent and remove modal backdrops
  (function() {
    // Function to remove backdrop
    function removeBackdrop() {
      const backdrops = document.querySelectorAll('.modal-backdrop');
      backdrops.forEach(backdrop => backdrop.remove());
      document.body.classList.remove('modal-open');
      document.body.style.overflow = '';
      document.body.style.paddingRight = '';
    }

    // Remove any existing backdrops immediately
    removeBackdrop();

    // Observe for new backdrop elements being added
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'childList') {
          mutation.addedNodes.forEach(function(node) {
            if (node.nodeType === 1 && node.classList &&
              (node.classList.contains('modal-backdrop') ||
                (node.classList.contains('fade') && node.classList.contains('show')))) {
              setTimeout(() => node.remove(), 10);
            }
          });
        }
      });
    });

    // Start observing
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });

    // Also remove backdrops periodically
    setInterval(removeBackdrop, 100);
  })();
</script>

{% endblock %}