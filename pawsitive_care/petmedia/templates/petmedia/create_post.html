{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}Create Blog Post - PetMedia{% endblock %}

{% block extra_css %}
<style>
  .image-upload-container {
    border: 2px dashed var(--border-medium);
    border-radius: var(--radius-lg);
    background: var(--surface-overlay);
    transition: all var(--transition-normal);
    position: relative;
  }

  .image-upload-container:hover {
    border-color: var(--sand-accent);
    background: var(--surface-glass);
    transform: translateY(-2px);
  }

  .upload-area {
    padding: 2.5rem 1.25rem;
    text-align: center;
    cursor: pointer;
    transition: all var(--transition-normal);
    color: var(--text-muted);
  }

  .upload-area:hover {
    background: var(--surface-elevated);
    color: var(--text-secondary);
  }

  .image-upload-container input[type="file"] {
    position: absolute;
    opacity: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
    top: 0;
    left: 0;
  }

  .upload-help {
    padding: 0.75rem;
    background: var(--surface-card);
    border-top: 1px solid var(--border-light);
    text-align: center;
    color: var(--text-muted);
    font-size: 0.875rem;
  }

  #image-preview {
    text-align: center;
    padding: 1.25rem;
    background: var(--surface-card);
    border-top: 1px solid var(--border-light);
  }

  #image-preview img {
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    transition: transform var(--transition-fast);
  }

  #image-preview img:hover {
    transform: scale(1.05);
  }

  /* Hide file input when image is selected */
  .image-selected .upload-area {
    display: none;
  }

  /* Button Styling */
  .btn-custom {
    background: linear-gradient(135deg, var(--primary-sand) 0%, var(--secondary-gold) 100%);
    color: var(--text-primary);
    border: 1px solid var(--border-accent);
    padding: 0.75rem 1.5rem;
    border-radius: var(--radius-lg);
    font-weight: 600;
    transition: all var(--transition-normal);
    box-shadow: var(--shadow-md);
    backdrop-filter: blur(10px);
  }

  .btn-custom:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    color: var(--text-primary);
    border-color: var(--accent-gold);
  }

  .btn-secondary {
    background: var(--surface-card);
    color: var(--text-secondary);
    border: 1px solid var(--border-light);
    backdrop-filter: blur(10px);
  }

  .btn-secondary:hover {
    background: var(--surface-elevated);
    color: var(--text-primary);
    transform: translateY(-1px);
  }

  /* Form Styling */
  .form-control,
  .form-select {
    background: var(--surface-card);
    border: 1px solid var(--border-light);
    color: var(--text-primary);
    border-radius: var(--radius-md);
    padding: 0.75rem;
    transition: all var(--transition-fast);
    backdrop-filter: blur(10px);
  }

  .form-control:focus,
  .form-select:focus {
    background: var(--surface-elevated);
    border-color: var(--accent-sand);
    box-shadow: 0 0 0 0.2rem rgba(212, 189, 150, 0.25);
    color: var(--text-primary);
  }

  .form-label {
    color: var(--text-primary);
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  /* Card Styling */
  .card {
    background: var(--surface-card);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    backdrop-filter: blur(10px);
  }

  .card-header {
    background: var(--surface-elevated);
    border-bottom: 1px solid var(--border-light);
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    padding: 1.25rem;
  }

  .card-header h3 {
    color: var(--text-primary);
    margin: 0;
  }

  .card-body {
    padding: 1.5rem;
  }

  /* Alert Styling */
  .alert-danger {
    background: rgba(220, 53, 69, 0.1);
    border: 1px solid rgba(220, 53, 69, 0.3);
    color: #721c24;
    border-radius: var(--radius-md);
    backdrop-filter: blur(10px);
  }

  .text-danger {
    color: #dc3545 !important;
  }

  .text-muted {
    color: var(--text-muted) !important;
  }

  .text-warning {
    color: #ffc107 !important;
  }

  .text-success {
    color: #198754 !important;
  }
</style>
{% endblock %}

{% block content %}
<div class="app-shell">
  {% include 'petmedia/includes/sidebar.html' %}

  <main class="app-main">
    <div class="container mt-4">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card">
            <div class="card-header">
              <h3 class="mb-0">Create New Blog Post</h3>
              <small class="text-muted">Share your pet stories, tips, and experiences with the community</small>
            </div>
            <div class="card-body">
              {% if form.errors %}
              <div class="alert alert-danger" role="alert">
                <h6 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Please correct the following errors:</h6>
                <ul class="mb-0">
                  {% for field, errors in form.errors.items %}
                  {% for error in errors %}
                  <li>
                    {% if field == '__all__' %}
                    {{ error }}
                    {% else %}
                    <strong>
                      {{ field|title }}:</strong>
                    {{ error }}
                    {% endif %}
                  </li>
                  {% endfor %}
                  {% endfor %}
                </ul>
              </div>
              {% endif %}

              <form method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- Title -->
                <div class="mb-3">
                  <label for="{{ form.title.id_for_label }}" class="form-label">
                    Post Title <span class="text-danger">*</span>
                  </label>
                  {{ form.title }}
                  {% if form.title.errors %}
                  <div class="text-danger small">
                    {{ form.title.errors.0 }}
                  </div>
                  {% endif %}
                </div>

                <!-- Category -->
                <div class="mb-3">
                  <label for="{{ form.category.id_for_label }}" class="form-label">Category</label>
                  {{ form.category }}
                  {% if form.category.errors %}
                  <div class="text-danger small">
                    {{ form.category.errors.0 }}
                  </div>
                  {% endif %}
                </div>

                <!-- Related Pet -->
                <div class="mb-3">
                  <label for="{{ form.related_pet.id_for_label }}" class="form-label">Related Pet</label>
                  {{ form.related_pet }}
                  <small class="form-text text-muted">
                    Select a pet if this post is about a specific pet.
                    {% if not user.pets.exists %}
                    <a href="{% url 'pets:pet_create' %}" class="text-primary">Add a pet first</a> to link them to your posts.
                    {% endif %}
                  </small>
                  {% if form.related_pet.errors %}
                  <div class="text-danger small mt-1">
                    {{ form.related_pet.errors.0 }}
                  </div>
                  {% endif %}
                </div>

                <!-- Excerpt -->
                <div class="mb-3">
                  <label for="{{ form.excerpt.id_for_label }}" class="form-label">Excerpt</label>
                  {{ form.excerpt }}
                  <small class="form-text text-muted">Brief description that will appear in post previews</small>
                  {% if form.excerpt.errors %}
                  <div class="text-danger small">
                    {{ form.excerpt.errors.0 }}
                  </div>
                  {% endif %}
                </div>

                <!-- Content -->
                <div class="mb-3">
                  <label for="{{ form.content.id_for_label }}" class="form-label">
                    Content <span class="text-danger">*</span>
                  </label>
                  {{ form.content }}
                  <small class="form-text text-muted">Write your full blog post content here (minimum 50 characters)</small>
                  {% if form.content.errors %}
                  <div class="text-danger small mt-1">
                    {{ form.content.errors.0 }}
                  </div>
                  {% endif %}
                </div>

                <!-- Featured Image -->
                <div class="mb-3">
                  <label for="{{ form.featured_image.id_for_label }}" class="form-label">Featured Image</label>
                  <div class="image-upload-container">
                    <div class="upload-area" onclick="document.getElementById('{{ form.featured_image.id_for_label }}').click();">
                      <i class="fas fa-cloud-upload-alt fa-2x text-primary mb-2"></i>
                      <p class="mb-1"><strong>Click to upload an image</strong></p>
                      <p class="text-muted small">or drag and drop here</p>
                    </div>
                    {{ form.featured_image }}
                    <div class="upload-help mt-2">
                      <small class="form-text text-muted">Supported: JPG, PNG, GIF - max 5MB</small>
                    </div>
                    <div id="image-preview" class="mt-3" style="display: none;">
                      <img id="preview-img" src="" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                      <p class="small text-success mt-1">Image ready for upload</p>
                    </div>
                  </div>
                  {% if form.featured_image.errors %}
                  <div class="text-danger small mt-1">
                    {{ form.featured_image.errors.0 }}
                  </div>
                  {% endif %}
                </div>

                <!-- SEO Meta Description -->
                <div class="mb-4">
                  <label for="{{ form.meta_description.id_for_label }}" class="form-label">Meta Description</label>
                  {{ form.meta_description }}
                  <small class="form-text text-muted">Optional: Brief description for search engines (recommended 150-160 characters)</small>
                  {% if form.meta_description.errors %}
                  <div class="text-danger small">
                    {{ form.meta_description.errors.0 }}
                  </div>
                  {% endif %}
                </div>

                <!-- Form Actions -->
                <div class="d-flex justify-content-between">
                  <a href="{% url 'petmedia:blog_list' %}" class="btn btn-outline-secondary btn-secondary">Cancel</a>
                  <div>
                    <button type="submit" class="btn btn-primary btn-custom">Create Post</button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <!-- Help Card -->
          <div class="card mt-4">
            <div class="card-header">
              <h5 class="mb-0">Writing Tips</h5>
            </div>
            <div class="card-body">
              <ul class="mb-0">
                <li>Be specific and detailed in your title</li>
                <li>Share personal experiences and what worked for you</li>
                <li>Include photos when possible to make posts more engaging</li>
                <li>Be respectful and supportive of other pet owners</li>
                <li>If sharing advice, mention when to consult a veterinarian</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Auto-resize textarea and add character count
  document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.querySelector('#id_content');
    if (textarea) {
      // Auto-resize functionality
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';

      textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';

        // Character count feedback
        const currentLength = this.value.length;
        const minLength = 50;
        let helpText = this.parentElement.querySelector('.form-text');

        if (currentLength < minLength) {
          helpText.innerHTML = `Write your full blog post content here (minimum 50 characters) - ${currentLength}/${minLength} characters`;
          helpText.className = 'form-text text-warning';
        } else {
          helpText.innerHTML = `Write your full blog post content here (minimum 50 characters) - ${currentLength} characters`;
          helpText.className = 'form-text text-success';
        }
      });
    }

    // Image upload preview and validation
    const imageInput = document.querySelector('#id_featured_image');
    const uploadContainer = document.querySelector('.image-upload-container');
    const previewContainer = document.getElementById('image-preview');
    const previewImg = document.getElementById('preview-img');

    if (imageInput && uploadContainer) {

      // File input change event
      imageInput.addEventListener('change', function(event) {
        const file = event.target.files[0];
        handleImageFile(file);
      });

      // Drag and drop functionality
      uploadContainer.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        this.style.borderColor = '#007bff';
        this.style.backgroundColor = '#e3f2fd';
      });

      uploadContainer.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        this.style.borderColor = '#dee2e6';
        this.style.backgroundColor = '#f8f9fa';
      });

      uploadContainer.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        this.style.borderColor = '#dee2e6';
        this.style.backgroundColor = '#f8f9fa';

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          imageInput.files = files;
          handleImageFile(files[0]);
        }
      });

      // Function to handle image file processing
      function handleImageFile(file) {
        if (file) {
          // Check file size (5MB limit)
          const maxSize = 5 * 1024 * 1024; // 5MB in bytes
          if (file.size > maxSize) {
            alert('File size must be less than 5MB');
            imageInput.value = '';
            hidePreview();
            return;
          }

          // Check file type
          if (!file.type.startsWith('image/')) {
            alert('Please select a valid image file');
            imageInput.value = '';
            hidePreview();
            return;
          }

          // Create preview
          const reader = new FileReader();
          reader.onload = function(e) {
            previewImg.src = e.target.result;
            showPreview();
          };
          reader.readAsDataURL(file);
        } else {
          hidePreview();
        }
      }

      function showPreview() {
        previewContainer.style.display = 'block';
        uploadContainer.classList.add('image-selected');
      }

      function hidePreview() {
        previewContainer.style.display = 'none';
        uploadContainer.classList.remove('image-selected');
      }

      // Add click to remove functionality
      previewContainer.addEventListener('click', function() {
        if (confirm('Remove selected image?')) {
          imageInput.value = '';
          hidePreview();
        }
      });

      // Debug logging
      console.log('Image upload functionality initialized');
      imageInput.addEventListener('click', function() {
        console.log('File input clicked');
      });
    }

    // Form validation before submit
    const form = document.querySelector('form');
    if (form) {
      form.addEventListener('submit', function(event) {
        let isValid = true;
        let firstErrorField = null;

        // Check content length
        const content = document.querySelector('#id_content');
        if (content && content.value.length < 50) {
          isValid = false;
          if (!firstErrorField) firstErrorField = content;
        }

        // Check title
        const title = document.querySelector('#id_title');
        if (title && title.value.trim() === '') {
          isValid = false;
          if (!firstErrorField) firstErrorField = title;
        }

        if (!isValid) {
          event.preventDefault();
          if (firstErrorField) {
            firstErrorField.focus();
            firstErrorField.scrollIntoView({
              behavior: 'smooth',
              block: 'center'
            });
          }
          alert('Please fill in all required fields correctly before submitting.');
        }
      });
    }
  });
</script>
{% endblock %}